---
- name: Play 1 - Fetch file from host
  hosts: fd*.shadowman.dev
  gather_facts: true
  
  vars
    array:
      user1: {{ ansible_facts['kernel'] }}
      user2: {{ ansible_facts['kernel'] }}
     
  tasks:

  - name: Fetch file to EE
    ansible.builtin.fetch:
      src: "/etc/{{ item }}"
      dest: "/tmp/{{ inventory_hostname }}/{{ item }}.txt"
      flat: true
    become: true
    #run_once: true
    register: myfile
    #delegate_to: "{{ inventory_hostname }}"
    loop:
      - sudoers
      - passwd
      - group

  - name: Update SNOW CMDB
    servicenow.itsm.configuration_item:
      state: "{{ status }}"
      name: "{{ inventory_hostname }}"
      sys_class_name: cmdb_ci_server
      #sys_id: "{{ system_id }}"
      attachments:
        - path: "/tmp/{{ inventory_hostname }}/{{ item }}.txt"
      other:
        #default_gateway: "{{ ansible_facts['default_ipv4']['gateway'] }}"
        os_version: "{{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}"
        cpu_count: "{{ ansible_facts['processor_nproc'] }}"
        default_gateway: "{{ ansible_facts['default_ipv4']['gateway'] }}"
        u_glide_list_2: "{{ array }}"
         
    delegate_to: localhost
    loop:
      - sudoers
      - passwd
      - group
